- name: Deploy app
  hosts: cloud
  gather_facts: false
  vars:
    container: nextcloud-aio-mastercontainer
  tasks:
    - name: Wait for connection
      ansible.builtin.wait_for_connection:
        timeout: 300
    - name: Deploy master container
      community.docker.docker_container:
        image: nextcloud/all-in-one:latest
        recreate: true
        state: started
        restart_policy: unless-stopped
        init: true
        name: "{{ container }}"
        published_ports:
          - 8080:8080
        env:
          NEXTCLOUD_UPLOAD_LIMIT: 16G
          NEXTCLOUD_MAX_TIME: "7200"
          NEXTCLOUD_ADDITIONAL_APKS: imagemagick ffmpeg
          APACHE_PORT: "11000"
          APACHE_IP_BINDING: "0.0.0.0"
          TZ: Europe/London
          AIO_DISABLE_BACKUP_SECTION: "true"
        volumes:
          - nextcloud_aio_mastercontainer:/mnt/docker-aio-config
          - /var/run/docker.sock:/var/run/docker.sock:ro

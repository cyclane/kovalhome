- name: Proxmox test-vm
  hosts: localhost
  module_defaults:
    community.general.proxmox_kvm:
      api_user: "{{ lookup('ansible.builtin.env', 'PROXMOX_TOKEN_ID') | regex_replace('!.*') }}"
      api_host: "{{ lookup('ansible.builtin.env', 'PROXMOX_HOST' ) }}"
      api_token_id: "{{ lookup('ansible.builtin.env', 'PROXMOX_TOKEN_ID') | regex_replace('.*!') }}"
      api_token_secret: "{{ lookup('ansible.builtin.env', 'PROXMOX_TOKEN_SECRET') }}"
      name: test-vm
      node: pve
  tasks:
    - name: Create test-vm
      community.general.proxmox_kvm:
        name: test-vm
        node: pve
    - name: Update test-vm
      community.general.proxmox_kvm:
        cpu: x86-64-v3
        memory: 2048
        cores: 3
        update: true
    - name: Start test-vm
      community.general.proxmox_kvm:
        state: restarted
